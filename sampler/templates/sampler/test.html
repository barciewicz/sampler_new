<!DOCTYPE HTML>
    <html>
        <head>
            <style>               
            </style>
        </head>
        <body>
            <canvas id="waveform"></canvas>
        </body>
        <script>
            class Waveform {
                constructor(container_selector) {
                    this.render(container_selector)
                    this.renderAudio()
                    this.rects = []
                }
                
                render(container_selector) {
                    this.canvas = document.querySelector(container_selector)
                    this.canvas.width = this.canvas.parentNode.offsetWidth
                    this.canvas.height = 150
                    this.canvas.style.border = '1px solid black'
                    this.canvas.oncontextmenu = () => false
                    this.ctx = this.canvas.getContext('2d')
                    
                    // rect color
                    this.ctx.fillStyle = 'rgba(200, 0, 0, 0.3)'
                    
                    this.canvas.addEventListener('mousedown', this.mouseDown)
                    this.canvas.addEventListener('mousemove', this.mouseMove)
                    this.canvas.addEventListener('mouseup', this.mouseUp)
                    this.canvas.addEventListener('dblclick', this.dblClick)
                }
                
                renderAudio() {
                    this.audio = document.createElement('audio')
                    this.audio.controls = true
                    document.body.appendChild(this.audio)
                }
                
                loadAudio(audio_url) {
                    this.audio.src = audio_url
                }
                
                mouseDown = e => {
                    if (e.button === 2) {
                            console.log('removing rect')
                            this.rects = this.rects.filter(rect => !rect.contains_x(e.clientX))
                            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height)
                            this.drawAllRects()
                            
                            sampler = sampler.filter(rect => this.rects.includes(rect))
                            console.log('sampler:', sampler)
                    }  
                    
                    if (e.button === 0) {
                        console.log('creating new rect')
                        this.drag = true
                        if (this.drag && !this.move) {
                            this.rect = new Rect()
                            this.rect.x = e.clientX - this.canvas.offsetLeft
                            this.rect.y = 0
                            this.rect.w = 1 // marker-like
                            this.rect.h = this.canvas.height
                            this.drawRect(this.rect)
                        }
                        
                        if (this.drag && this.move) {
                            this.rect = this.rects.find(rect => rect.contains_x(e.clientX))
                        }
                    }
                }
                
                mouseMove = e => {
                    if (!this.drag) {
                        if (this.rects.some(rect => rect.contains_x(e.clientX))) {
                                document.body.style.cursor = 'move'
                                this.move = true
                            } else {
                                document.body.style.cursor = 'default'
                                this.move = false
                            }      
                    }
                    
                    if (this.drag && !this.move) {
                        console.log('resizing rect')
                        // clear entire canvas
                        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height)
                        
                        // // redraw background image (waveform)
                        // let image = new Image(800, 150)
                        // image.src = 'Sticky.PNG'
                        // this.ctx.drawImage(image, 0, 0)
                        
                        //redraw all stored rects
                        this.drawAllRects()
                        
                        // resize current rect
                        this.rect.w = (e.clientX - this.canvas.offsetLeft) - this.rect.x;
                        this.drawRect(this.rect)
                    }
                    
                    if (this.drag && this.move) {
                        console.log('moving rect')
                        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height)  
                        
                        // avoid drawing same rect again
                        this.drawAllRects(this.rect)
                        
                        this.rect.x = this.rect.x + (e.clientX - this.rect.x) 
                        this.drawRect(this.rect)
                    }
                }
                
                mouseUp = e => {
                    if (e.button === 0) {
                        this.drag = false
                         
                        // store rects to redraw them on mousemove
                        if (!this.move) {
                            this.rects.push(this.rect)
                        }

                        //console.log(this.rects)
                    }
                }
                
                dblClick = e => {
                    console.log('adding rect/rects to sampler')
                    let rect_or_rects = this.rects.filter(rect => rect.contains_x(e.clientX))
                    sampler.push(rect_or_rects)
                    console.log('sampler:', sampler)
                }

                drawRect(rect) {
                    this.ctx.fillRect(rect.x, rect.y, rect.w, rect.h)
                }
                
                drawAllRects(exclude_rect) {
                    this.rects.forEach(rect => {
                        if (rect !== exclude_rect) this.drawRect(rect)
                    })
                }
                
                rectToRegion = rect => {
                    let el = document.createElement('div')
                    el.style.display = 'absolute'
                    el.style.left = rect.x
                    el.style.top = rect.y
                    el.style.width = rect.w + 'px'
                    el.style.height = rect.h + 'px'
                    el.style.backgroundColor = 'yellow'
                    document.body.appendChild(el)
                    return el
                }
                
            }                  
            
            class Rect {
                constructor() {
                    this.x = 0
                    this.y = 0
                    this.w = 0
                    this.h = 0
                }
                
                contains_x = x => 
                    (x >= this.x && x <= this.x + this.w) || // rect drawn left to right (has positive width)
                    (x <= this.x && x >= this.x + this.w)    // rect drawn right to left (has negative width)
                    ? true : false  
            }
            
            let waveform = new Waveform('#waveform')        
            
            let sampler = []
            
            
            
        </script>
    </html>
